CREATE OR REPLACE FUNCTION AddUserFromJson(
    p_UserData JSONB
)
RETURNS JSONB AS
$$
DECLARE
    inserted_user JSONB;
BEGIN
    INSERT INTO Users (UserName, Email, PasswordHash, Role, Age)
    VALUES (
        p_UserData->>'UserName',
        p_UserData->>'Email',
        p_UserData->>'PasswordHash',
        p_UserData->>'Role',
        (p_UserData->>'Age')::INT
    )
    RETURNING to_jsonb(Users) INTO inserted_user;

    RETURN inserted_user;
END;
$$ LANGUAGE plpgsql;
public async Task<string> AddUserAsync(User user)
{
    using var connection = new NpgsqlConnection(_connectionString);

    var userJson = JsonSerializer.Serialize(user);
    var parameters = new DynamicParameters();
    parameters.Add("p_UserData", userJson, DbType.String);

    var insertedUserJson = await connection.QuerySingleAsync<string>(
        "AddUserFromJson",
        parameters,
        commandType: CommandType.StoredProcedure);

    return insertedUserJson;
}
