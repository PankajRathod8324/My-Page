$(document).on("click", ".modifieraddbtn", function () {
    console.log(ItemIdTemp + "TempID");
    console.log("ItemDetailsArray length: " + ItemDetailsArray.length);

    if (ItemDetailsArray.length === 0) {
        ItemDetailsArray.push({
            ItemId: ItemIdTemp,
            MenuItemModifier: []
        });
        console.log(ItemDetailsArray);
    }

    const currentItem = ItemDetailsArray.find(item => item.ItemId === ItemIdTemp);
    const currentModifiers = currentItem?.MenuItemModifier || [];

    // Check if this exact item + modifiers already exists
    const isDuplicate = AppendedItemsArray.some(appended => {
        if (appended.ItemId !== ItemIdTemp) return false;

        const appendedMods = appended.MenuItemModifier.map(m => m.ModifierId).sort();
        const currentMods = currentModifiers.map(m => m.ModifierId).sort();

        return JSON.stringify(appendedMods) === JSON.stringify(currentMods);
    });

    if (isDuplicate) {
        toastr.warning("This item with the same modifiers already exists.");
        return;
    }

    // Not a duplicate, proceed and track it
    AppendedItemsArray.push({
        ItemId: ItemIdTemp,
        MenuItemModifier: currentModifiers.map(m => ({ ModifierId: m.ModifierId }))
    });

    $.ajax({
        url: '@Url.Action("GetMenuItemDetails", "AccountManagerOrderApp")',
        type: "POST",
        data: JSON.stringify(ItemDetailsArray),
        contentType: 'application/json',
        success: function (response) {
            $("#modifierdatamodal").modal('hide');
            $("#orderitemomdifier").append(response);

            let total = 0;

            $(".ItemDataCard").each(function () {
                let rate = parseFloat($(this).find('.itemrate').text()) || 0;
                let modifierrate = parseFloat($(this).find('.modifierrate').text()) || 0;
                total += (rate + modifierrate);
            });

            FinalSubtotalSum = total;
            $(".subtotal").text(total.toFixed(2));

            calculateTax();

            let finaltotal = parseFloat((FinalSubtotalSum + FinalTaxSum)).toPrecision(5);
            $(".finaltotalamt").text(finaltotal);
            FinalOrderSum = finaltotal;

            selecteditem = [];
            selectedmodifier = [];
            ItemDetailsArray = [];

            console.log("Final Order Total: " + FinalOrderSum);
        },
        error: function (xhr, status, error) {
            console.error("Error fetching order details:", error);
        }
    });
});
