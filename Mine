$(document).on("click", ".modifieraddbtn", function () {
    if (ItemDetailsArray.length === 0) {
        ItemDetailsArray.push({
            ItemId: ItemIdTemp,
            MenuItemModifier: []
        });
    }

    const currentItem = ItemDetailsArray.find(item => item.ItemId === ItemIdTemp);
    const currentModifiers = currentItem?.MenuItemModifier || [];

    // Try to find a match in the appended list
    const existingIndex = AppendedItemsArray.findIndex(appended => {
        if (appended.ItemId !== ItemIdTemp) return false;

        const appendedMods = appended.MenuItemModifier.map(m => m.ModifierId).sort();
        const currentMods = currentModifiers.map(m => m.ModifierId).sort();

        return JSON.stringify(appendedMods) === JSON.stringify(currentMods);
    });

    if (existingIndex !== -1) {
        // Item with same modifiers exists → Increase quantity
        AppendedItemsArray[existingIndex].Quantity += 1;
        toastr.info("Quantity increased for existing item.");
        console.log(AppendedItemsArray);
        return;
    }

    // If not duplicate → Push new entry with quantity 1
    AppendedItemsArray.push({
        ItemId: ItemIdTemp,
        MenuItemModifier: currentModifiers.map(m => ({ ModifierId: m.ModifierId })),
        Quantity: 1
    });

    $.ajax({
        url: '@Url.Action("GetMenuItemDetails", "AccountManagerOrderApp")',
        type: "POST",
        data: JSON.stringify(ItemDetailsArray),
        contentType: 'application/json',
        success: function (response) {
            $("#modifierdatamodal").modal('hide');
            $("#orderitemomdifier").append(response);

            let total = 0;

            $(".ItemDataCard").each(function () {
                let rate = parseFloat($(this).find('.itemrate').text()) || 0;
                let modifierrate = parseFloat($(this).find('.modifierrate').text()) || 0;
                total += (rate + modifierrate);
            });

            FinalSubtotalSum = total;
            $(".subtotal").text(total.toFixed(2));

            calculateTax();

            let finaltotal = parseFloat((FinalSubtotalSum + FinalTaxSum)).toPrecision(5);
            $(".finaltotalamt").text(finaltotal);
            FinalOrderSum = finaltotal;

            selecteditem = [];
            selectedmodifier = [];
            ItemDetailsArray = [];

            console.log("Final Order Total: " + FinalOrderSum);
        },
        error: function (xhr, status, error) {
            console.error("Error fetching order details:", error);
        }
    });
});
