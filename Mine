List<OrderVM> orderVm = _context.Orders.Where(i => orderIds.Contains(i.OrderId)).Select(o => new OrderVM
{
    OrderId = o.OrderId,
    OccupiedTime = DateTime.Now - o.CreatedAt,
    OrderInstruction = o.OrderInstructions,

    OrderItems = _context.OrderItems
        .Where(oi => oi.OrderId == o.OrderId && oi.ItemId.HasValue && _context.MenuItems.Any(mi => mi.ItemId == oi.ItemId))
        .SelectMany(oi => new List<OrderItemVM>
        {
            // Ready Items
            new OrderItemVM
            {
                ItemId = (int)oi.ItemId,
                ItemName = _context.MenuItems.Where(mi => mi.ItemId == oi.ItemId).Select(mi => mi.ItemName).FirstOrDefault(),
                Price = oi.Rate,
                Quantity = oi.Readyitemquantity,
                ItemInstructions = oi.ItemInstructions,
                Status = oi.Readyitemquantity > 0 ? "Ready" : null, // Optional for clarity
                Modifiers = _context.OrderModifiers.Where(om => om.OrderItemId == oi.OrderItemId && om.ItemId == oi.ItemId)
                    .Select(om => new OrderModifierVM
                    {
                        ModifierId = (int)om.ModifierId,
                        ModifierName = _context.MenuModifiers.Where(mod => mod.ModifierId == om.ModifierId).Select(mod => mod.ModifierName).FirstOrDefault(),
                        ModifierRate = om.Rate,
                        Quantity = om.Quantity
                    }).ToList()
            },

            // In Progress Items
            new OrderItemVM
            {
                ItemId = (int)oi.ItemId,
                ItemName = _context.MenuItems.Where(mi => mi.ItemId == oi.ItemId).Select(mi => mi.ItemName).FirstOrDefault(),
                Price = oi.Rate,
                Quantity = (oi.Quantity - oi.Readyitemquantity),
                ItemInstructions = oi.ItemInstructions,
                Status = (oi.Quantity - oi.Readyitemquantity) > 0 ? "In Progress" : null,
                Modifiers = _context.OrderModifiers.Where(om => om.OrderItemId == oi.OrderItemId && om.ItemId == oi.ItemId)
                    .Select(om => new OrderModifierVM
                    {
                        ModifierId = (int)om.ModifierId,
                        ModifierName = _context.MenuModifiers.Where(mod => mod.ModifierId == om.ModifierId).Select(mod => mod.ModifierName).FirstOrDefault(),
                        ModifierRate = om.Rate,
                        Quantity = om.Quantity
                    }).ToList()
            }

        })
        .Where(x => x.Quantity > 0) // Remove zero quantity records
        .ToList(),

    OrderTables = _context.OrderTables.Where(r => r.OrderId == o.OrderId).Select(ot => new OrderTableVM
    {
        TableId = (int)ot.TableId,
        TableName = ot.TableId.HasValue ? _context.Tables.Where(t => t.TableId == ot.TableId).Select(t => t.TableName).FirstOrDefault() : "No Table",
        SectionName = ot.TableId.HasValue ? (from t in _context.Tables join s in _context.Sections on t.SectionId equals s.SectionId where t.TableId == ot.TableId select s.SectionName).FirstOrDefault() : "No Section"
    }).ToList(),

}).ToList();
