CREATE PROCEDURE GetOrdersWithRelatedData
AS
BEGIN
    SELECT 
        o.OrderId,
        o.CreatedAt,
        o.OrderInstructions,
        o.OrderStatusId,

        oi.OrderItemId,
        oi.ItemId,
        oi.Quantity,
        oi.ReadyItemQuantity,
        oi.Rate,
        oi.ItemInstructions,
        oi.CategoryId,

        mi.ItemName,
        mi.CategoryId AS MenuCategoryId,

        om.OrderModifierId,
        om.ModifierId,
        om.Rate AS ModifierRate,

        mm.ModifierName,

        c.CustomerId,

        ct.CustomerTableId,
        ct.TableId,
        t.TableName,
        s.SectionName

    FROM Orders o
    INNER JOIN OrderItems oi ON o.OrderId = oi.OrderId
    LEFT JOIN MenuItems mi ON oi.ItemId = mi.ItemId
    LEFT JOIN OrderModifiers om ON oi.OrderItemId = om.OrderItemId
    LEFT JOIN MenuModifiers mm ON om.ModifierId = mm.ModifierId
    LEFT JOIN Customers c ON o.CustomerId = c.CustomerId
    LEFT JOIN CustomerTables ct ON c.CustomerId = ct.CustomerId AND ct.IsActive = 1
    LEFT JOIN Tables t ON ct.TableId = t.TableId
    LEFT JOIN Sections s ON t.SectionId = s.SectionId
    WHERE o.OrderStatusId NOT IN (3, 4)
END
